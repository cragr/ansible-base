- name: Retrieve OpenShift pull secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: pull-secret
    namespace: openshift-config
  register: openshift_pull_secret

- name: Create objects for deployment of {{ multicluster_engine_hosted_cluster.cluster_name }} hosted cluster
  kubernetes.core.k8s:
    template:
      - cluster-aws-creds-secret.yaml
      - cluster-hd.yaml

- name: Waiting since {{ lookup("pipe", "date +%r") }} for {{ multicluster_engine_hosted_cluster.cluster_name }} to deploy
  kubernetes.core.k8s_info:
    api_version: hypershift.openshift.io/v1alpha1
    kind: HostedCluster
    name: '{{ multicluster_engine_hosted_cluster.cluster_name }}'
    namespace: clusters
  register: hosted_cluster
  until:
    - hosted_cluster.resources is defined
    - hosted_cluster.resources | length > 0
    - hosted_cluster.resources.0.status is defined
    - hosted_cluster.resources.0.status.conditions is defined
    - hosted_cluster.resources.0.status.conditions | selectattr('type', 'equalto', 'Available') | list | length > 0
    - (hosted_cluster.resources.0.status.conditions | selectattr('type', 'equalto', 'Available') | first).status == "True"
  retries: 240
  delay: 10

- debug:
    msg: |
      Cluster {{ multicluster_engine_hosted_cluster.cluster_name }} deployd successfully.
      You can download the admin kubeconfig by issuing 'oc extract -n clusters secret/{{ multicluster_engine_hosted_cluster.cluster_name }}-admin-kubeconfig'
