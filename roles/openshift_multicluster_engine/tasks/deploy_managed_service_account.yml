- name: Deploy managedserviceaccount addon for local cluster
  kubernetes.core.k8s:
    template: instance/managed-serviceaccount-managedclusteraddon.yaml

- name: Deploy test-serviceaccount
  kubernetes.core.k8s:
    template: instance/test-serviceaccount-managedserviceaccount.yaml

- name: Retrieve service account secret name
  kubernetes.core.k8s_info:
    api_version: authentication.open-cluster-management.io/v1alpha1
    kind: ManagedServiceAccount
    name: test-serviceaccount
    namespace: local-cluster
  register: test_serviceaccount
  until:
    - test_serviceaccount.resources is defined
    - test_serviceaccount.resources | length > 0
    - test_serviceaccount.resources.0.status is defined
    - test_serviceaccount.resources.0.status.tokenSecretRef is defined
    - test_serviceaccount.resources.0.status.tokenSecretRef.name is defined
  retries: 80
  delay: 10

- name: Retrieve service account secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: '{{ test_serviceaccount.resources.0.status.tokenSecretRef.name }}'
    namespace: local-cluster
  register: test_serviceaccount_secret

- name: Fail if the service account secret can't be found
  fail:
  when: test_serviceaccount_secret.resources | length != 1
