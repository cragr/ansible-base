# Install Argo CD Notifications
# https://argocd-notifications.readthedocs.io/en/stable/
# Eventually Argo CD Notifications will be likely packaged with the OpenShift GitOps:
# https://issues.redhat.com/browse/GITOPS-927

- name: Install Argo CD Notifications and its catalog
  kubernetes.core.k8s:
    definition: "{{ lookup('url', item, split_lines=False) }}"
    namespace: '{{ gitops_instance_namespace }}'
  loop:
    - '{{ argocd_notifications_manifests }}'
    - '{{ argocd_notifications_catalog }}'

- name: Obtain Argo CD route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: '{{ gitops_instance_name }}-server'
    namespace: '{{ gitops_instance_namespace }}'
  register: argocd_route

- name: Send all notifications to the custom webhook receiver
  kubernetes.core.k8s:
    definition: "{{ lookup('template', item) }}"
  loop:
    - argocd-notifications-cm-cm.yaml

- import_role:
    name: openshift_common
    tasks_from: wait_for_deployment.yml
  vars:
    wait_for_deployment_name: '{{ argocd_notifications_controller_name }}'
    wait_for_deployment_namespace: '{{ gitops_instance_namespace }}'

- name: Deploy custom webhook receiver
  import_role:
    name: openshift_webhook_receiver
    tasks_from: deploy.yml
  vars:
    openshift_webhook_receiver_namespace: '{{ gitops_instance_namespace }}'
