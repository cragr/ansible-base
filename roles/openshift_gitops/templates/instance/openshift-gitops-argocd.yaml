apiVersion: argoproj.io/v1alpha1
kind: ArgoCD
metadata:
  name: {{ gitops_instance_name }}
  namespace: {{ gitops_instance_namespace }}
spec:
  ha:
    enabled: {{ gitops_instance_high_availability }}
  repo:
    replicas: 1
    volumeMounts:
    - mountPath: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
      subPath: ca-bundle.crt
      name: trusted-ca-bundle
    volumes:
      - configMap:
          name: trusted-ca-bundle
        name: trusted-ca-bundle
        optional: true
  server:
    replicas: 1
    # Configure TLS edge-terminated route instead of passthrough
    # so that the route utilizes OpenShift wildcard certificate
    insecure: true
  # Enable Helm templating in Kustomize
  kustomizeBuildOptions: --enable-helm
  rbac:
    defaultPolicy: 'role:readonly'
    policy: |
      g, cluster-admins, role:admin
    scopes: '[groups]'
  monitoring:
    enabled: true
  notifications:
    enabled: true
  extraConfig:
    repositories: |
      - type: helm
        url: https://external-secrets.github.io/kubernetes-external-secrets
        name: external-secrets
{% if gitops_autogitops_enabled %}
      - type: git
        url: {{ autogitops_git_repo_url_plain }}
        name: auto-gitops
        usernameSecret:
          name: auto-gitops
          key: username
        passwordSecret:
          name: auto-gitops
          key: password
{% endif %}
    # Extend the expiration period of the user authentication token generated by Argo CD. Default is 24 hours.
    users.session.duration: '31d'
    # By default, all connections made by the API server to OIDC providers must pass certificate validation.
    # See also https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/#skipping-certificate-verification-on-oidc-provider-connections
    oidc.tls.insecure.skip.verify: '{{ gitops_instance_oidc_tls_insecure_skip_verify }}'
  resourceHealthChecks:
{% for item in gitops_instance_health_check_files.files %}
    - group: {{ item.path | dirname | dirname | basename }}
      kind: {{ item.path | dirname | basename }}
      check: |
        {{ lookup('file', item.path, rstrip=false) | indent(8) }}
{% endfor %}
