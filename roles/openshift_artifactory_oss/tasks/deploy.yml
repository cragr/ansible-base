- name: Create Artifactory OSS namespace
  kubernetes.core.k8s:
    definition: '{{ lookup("template", item) }}'
  loop:
    - artifactory-oss-ns.yaml
    - artifactory-oss-scc-rolebinding.yaml
    - artifactory-oss-scc-role.yaml

- name: Add JFrog chart repo
  kubernetes.core.helm_repository:
    name: jfrog
    repo_url: '{{ artifactory_oss_helm_repo }}'

- name: Deploy Artifactory OSS
  kubernetes.core.helm:
    name: '{{ artifactory_oss_name }}'
    chart_ref: jfrog/artifactory-oss
    chart_version: '{{ artifactory_oss_version | default(omit) }}'
    release_namespace: '{{ artifactory_oss_namespace }}'
    release_values: '{{ lookup("template", "values.yaml") | from_yaml }}'
    wait: true

- name: Expose Artifactory OSS
  kubernetes.core.k8s:
    definition: "{{ lookup('template', '{{ item }}') }}"
  loop:
    - artifactory-oss-route.yaml
