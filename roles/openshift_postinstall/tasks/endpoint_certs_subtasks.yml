- name: Create the certificate secrets
  kubernetes.core.k8s:
    template: cert-secret.yaml
  no_log: true
  loop:
    - name: api-cert
      namespace: openshift-config
      crt: '{{ openshift_postinstall_endpoint_certs[openshift_common_cluster_domain].api.crt }}'
      key: '{{ openshift_postinstall_endpoint_certs[openshift_common_cluster_domain].api.key }}'
    - name: wildcard-cert
      namespace: openshift-ingress
      crt: '{{ openshift_postinstall_endpoint_certs[openshift_common_cluster_domain].ingress.crt }}'
      key: '{{ openshift_postinstall_endpoint_certs[openshift_common_cluster_domain].ingress.key }}'

- name: Configure API server certificate
  kubernetes.core.k8s:
    template: cluster-apiserver-2.yaml
  register: openshift_postinstall_api_cert

- name: Configure wildcard apps certificate
  kubernetes.core.k8s:
    template: default-ingresscontroller-2.yaml
  register: openshift_postinstall_apps_cert

- import_role:
    name: openshift_common
    tasks_from: wait_for_stable_cluster.yml
  vars:
    stable_cluster_delay: 120
    stable_cluster_retries: 10
    stable_cluster_validate_certs: false
  when: >
    (openshift_postinstall_api_cert is changed) or
    (openshift_postinstall_apps_cert is changed)
