- name: Create Kyverno namespace
  kubernetes.core.k8s:
    template: kyverno-ns.yaml

- name: Add Kyverno chart repo
  kubernetes.core.helm_repository:
    name: kyverno
    repo_url: '{{ kyverno_helm_repo }}'

- name: Deploy Kyverno
  kubernetes.core.helm:
    name: '{{ kyverno_name }}'
    chart_ref: kyverno/kyverno
    chart_version: '{{ kyverno_version | default(omit) }}'
    release_namespace: '{{ kyverno_namespace }}'
    release_values: '{{ lookup("template", "values.yaml") | from_yaml }}'
    wait: true

- import_role:
    name: openshift_common
    tasks_from: wait_for_deployment.yml
  vars:
    wait_for_deployment_name: '{{ kyverno_name }}'
    wait_for_deployment_namespace: '{{ kyverno_namespace }}'

- name: Deploy Kyverno policies
  kubernetes.core.helm:
    name: '{{ kyverno_name }}-policies'
    chart_ref: kyverno/kyverno-policies
    chart_version: '{{ kyverno_version | default(omit) }}'
    release_namespace: '{{ kyverno_namespace }}'
