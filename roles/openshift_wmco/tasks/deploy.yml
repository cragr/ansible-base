- name: Deploy Windows Machine Config Operator (WMCO)
  kubernetes.core.k8s:
    template:
      - windows-machine-config-operator-ns.yaml
      - windows-machine-config-operator-og.yaml
      - windows-machine-config-operator-sub.yaml

- import_role:
    name: openshift_common
    tasks_from: wait_for_operator.yml
  vars:
    subscription_name: '{{ wmco_subscription_name }}'
    subscription_namespace: '{{ wmco_subscription_namespace }}'

- name: Install private SSH key
  kubernetes.core.k8s:
    template: cloud-private-key-secret.yaml

- name: Waiting since {{ lookup("pipe", "date +%r") }} for openshift-machine-api/windows-user-data secret to appear
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    namespace: openshift-machine-api
    name: windows-user-data
  register: wmco_windows_user_data
  until:
    - wmco_windows_user_data.resources | length > 0
    - wmco_windows_user_data.resources.0.data is defined
    - wmco_windows_user_data.resources.0.data.userData is defined
  retries: 60
  delay: 10

- name: If you are bringing your own host, you can use this script to enable SSH on it
  debug:
    var: wmco_windows_user_data.resources.0.data.userData | b64decode

- name: Create Windows instances configmap
  kubernetes.core.k8s:
    template: windows-instances-cm.yaml

- name: Create Windows runtime class
  kubernetes.core.k8s:
    template: windows-runtimeclass.yaml

- import_tasks: deploy_sample_workload.yml
