- import_tasks: install_operator.yml

- name: Deploy RHACS Central
  kubernetes.core.k8s:
    template:
      - namespace/stackrox-ns.yaml
      - central/central-htpasswd-secret.yaml
      - central/central-db-password-secret.yaml
      - central/scanner-db-password-secret.yaml
      - central/stackrox-central-services-central.yaml

- import_role:
    name: openshift_common
    tasks_from: get_cluster_domain.yml

- name: Configure custom Central ingress certificate
  kubernetes.core.k8s:
    template:
      - central/central-default-tls-cert-secret.yaml
  when: rhacs_central_default_tls_cert[openshift_common_cluster_domain] is defined

- name: Obtain Central TLS secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: central-tls
    namespace: '{{ rhacs_instance_namespace }}'
  register: rhacs_central_tls
  until: rhacs_central_tls.resources | length == 1
  retries: 12
  delay: 10

- name: Create a reencrypt route
  kubernetes.core.k8s:
    template: central/central-reencrypt-route.yaml
