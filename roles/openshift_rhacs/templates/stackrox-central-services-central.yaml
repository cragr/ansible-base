apiVersion: platform.stackrox.io/v1alpha1
kind: Central
metadata:
  name: stackrox-central-services
  namespace: {{ rhacs_instance_namespace }}
spec:
  central:
    adminPasswordSecret:
      name: central-htpasswd
    defaultTLSSecret:
      name: central-tls
    db:
      isEnabled: Enabled
      passwordSecret:
        name: central-db-password
    exposure:
      loadBalancer:
        enabled: false
        port: 443
      nodePort:
        enabled: false
      route:
        enabled: true
    monitoring:
      exposeEndpoint: Enabled
    persistence:
      persistentVolumeClaim:
        claimName: stackrox-db
{% if rhacs_central_deployment_mode == 'dev' %}
    resources:
      limits:
        cpu: 4000m
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 1Gi
{% endif %}
  egress:
    connectivityPolicy: Online
  scanner:
    analyzer:
      scaling:
{% if rhacs_central_deployment_mode == 'dev' %}
        autoScaling: Disabled
        replicas: 1
{% endif %}
{% if rhacs_central_deployment_mode == 'prod' %}
        autoScaling: Enabled
        maxReplicas: 5
        minReplicas: 2
        replicas: 3
{% endif %}
    scannerComponent: Enabled
  customize:
    annotations:
      # These annotations make the central-reencrypt route work with OIDC. The annotations are required to be
      # attached to the central serviceaccount object only. Unfortunately, the operator configuration doesn't
      # allow attaching annotations to a select object. The annotations are attached to all managed objects
      # even when not necessary.
      serviceaccounts.openshift.io/oauth-redirectreference.custom: >-
        {"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"central-reencrypt"}}
      serviceaccounts.openshift.io/oauth-redirecturi.custom: sso/providers/openshift/callback
{% if rhacs_additional_trusted_ca is defined %}
  tls:
    additionalCAs:
      - name: custom_trusted_ca
        content: |
          {{ rhacs_additional_trusted_ca | indent(10) }}
{% endif %}
