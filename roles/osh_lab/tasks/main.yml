- name: Check if default storage class exists
  import_role:
    name: openshift_common
    tasks_from: check_default_storage_class_exists.yml

- import_role:
    name: openshift_openebs
    tasks_from: deploy.yml
  when: not default_storage_class_exists

- name: Set openshift_common_cluster_wide_proxy
  set_fact:
    openshift_common_cluster_wide_proxy: '{{ osh_lab_proxy | default({}) }}'

- import_role:
    name: openshift_common
    tasks_from: postinstall_common.yml
  when: openshift_common_cluster_wide_proxy

- name: Obtain infrastructure info
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Infrastructure
    name: cluster
  register: osh_lab_infrastructure

- name: Set osh_lab_cluster_domain
  set_fact:
    osh_lab_cluster_domain: '{{ osh_lab_infrastructure.resources.0.status.apiServerURL | regex_replace("https://api\.(.*):6443", "\1") }}'

- name: Set openshift_common_endpoint_certs
  set_fact:
    openshift_common_endpoint_certs: '{{ osh_lab_certs[osh_lab_cluster_domain] | default({}) }}'

- import_role:
    name: openshift_common
    tasks_from: postinstall_endpoint_certs.yml
  when: openshift_common_endpoint_certs
