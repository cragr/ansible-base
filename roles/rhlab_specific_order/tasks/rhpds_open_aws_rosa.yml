- name: Order the service
  import_role:
    name: otlc_generic_order
  vars:
    otlc_order_wait_retries: 480

- set_fact:
    otlc_service_raw:
      guid: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "babylon_guid") | first).value }}'
      env1: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 001") | first).value }}'
      env2: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 002") | first).value }}'
      env3: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 003") | first).value }}'
      env4: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 004") | first).value }}'
      env5: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 005") | first).value }}'
      env6: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 006") | first).value }}'
      env7: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 007") | first).value }}'
      env8: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 008") | first).value }}'
      env9: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 009") | first).value }}'
      env10: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 010") | first).value }}'
      env11: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 011") | first).value }}'
      env12: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 012") | first).value }}'
      env13: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 013") | first).value }}'
      env14: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 014") | first).value }}'
      env15: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 015") | first).value }}'
      env16: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 016") | first).value }}'
      env17: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 017") | first).value }}'
      env18: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 018") | first).value }}'
      env19: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 019") | first).value }}'
      env20: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 020") | first).value }}'
      env21: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 021") | first).value }}'
      env22: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "Environment Info 022") | first).value }}'
      target_host: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "targetHost") | first).value }}'
      aws_region: '{{ (otlc_service_attributes.json.custom_attributes | selectattr("name", "equalto", "ec2region") | first).value }}'

- set_fact:
    otlc_service_info:
      guid:                  '{{ otlc_service_raw.guid }}'
      top_level_domain:      '{{ otlc_service_raw.target_host | regex_replace("^bastion\.", "")}}'
      aws_access_key_id:     '{{ otlc_service_raw.env2.split(":").1 | trim }}'
      aws_secret_access_key: '{{ otlc_service_raw.env3.split(":").1 | trim }}'
      ssh_username:          '{{ otlc_service_raw.env21.split(" ")[-1].split("@").0 | trim }}'
      ssh_hostname:          '{{ otlc_service_raw.env21.split(" ")[-1].split("@").1 | trim }}'
      ssh_password:          '{{ otlc_service_raw.env22.split(" ")[-1] | trim }}'
      aws_region:            '{{ otlc_service_raw.aws_region }}'

- debug:
    var: otlc_service_info
