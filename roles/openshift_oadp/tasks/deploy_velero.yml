- name: Deploy Velero instance
  kubernetes.core.k8s:
    template:
      - velero-instance/cloud-credentials-secret.yaml
      - velero-instance/velero-dataprotectionapplication.yaml

- name: Enable CSI volume snapshotting on AWS
  kubernetes.core.k8s:
    template:
      - aws/velero-ebs-csi-aws-vsclass.yaml
  when: infrastructure.resources.0.status.platformStatus.type == 'AWS'

- import_role:
    name: openshift_common
    tasks_from: wait_for_deployment.yml
  vars:
    wait_for_deployment_name: '{{ velero_instance_name }}'
    wait_for_deployment_namespace: '{{ velero_instance_namespace }}'
