- name: DataMover repository configuration
  kubernetes.core.k8s:
    template: instance/dm-credential-secret.yaml
  when: velero_datamover_enabled

- name: Deploy Velero instance
  kubernetes.core.k8s:
    template:
      - instance/cloud-credentials-secret.yaml
      - instance/velero-dataprotectionapplication.yaml

- name: Enable CSI volume snapshotting on AWS
  kubernetes.core.k8s:
    template:
      - aws/csi-aws-vsc-vsclass.yaml
  when: velero_instance_aws_enabled

- import_role:
    name: openshift_common
    tasks_from: wait_for_deployment.yml
  vars:
    wait_for_deployment_name: '{{ velero_instance_name }}'
    wait_for_deployment_namespace: '{{ velero_instance_namespace }}'
