apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionApplication
metadata:
  name: velero
  namespace: {{ velero_instance_namespace }}
spec:
  configuration:
    velero:
      defaultPlugins:
        # The openshift plug-in is mandatory.
        - openshift
        - aws
{% if infrastructure.resources.0.status.platformStatus.type == 'None' %}
        - csi
      featureFlags:
        # OADP operator sets the EnableCSI feature flag automatically if the csi plugin
        # was included in the defaultVeleroPlugins list.
        #- EnableCSI
{% endif %}
{% if infrastructure.resources.0.status.platformStatus.type == 'VSphere' %}
      customPlugins:
        # OADP operator doesn't support vsphere on the default Velero plugin list.
        # Need to enable vsphere plugin as a custom Velero plugin.
        - name: vsphere
          image: vsphereveleroplugin/velero-plugin-for-vsphere:v1.3.0-rc2
      featureFlags:
        # If local mode is enabled, Velero vSphere plugin will skip the upload of volume
        # snapshots to S3. The datamgr-for-vsphere-plugin pod won't be deployed at all.
        #- EnableLocalMode
{% endif %}
      # If you need to install Velero without a default backup storage location
      # NoDefaultBackupLocation flag is required for confirmation
      noDefaultBackupLocation: false
    restic:
      enable: false
  backupLocations:
    - velero:
        provider: aws
        # Default indicates this location is the default backup storage location
        default: true
        objectStorage:
          # Name of an existing bucket
          bucket: {{ velero_instance_bucket_name }}
          # In the bucket, a prefix subdirectory will be created
          prefix: velero
        config:
{% if infrastructure.resources.0.status.platformStatus.type != 'AWS' %}
          s3Url: http://minio.oadp-operator.svc.cluster.local:9000
          s3ForcePathStyle: "true"
          #insecureSkipTLSVerify: "true"
{% endif %}
          region: {{ velero_instance_bucket_region }}
          # Choose a profile from the AWS config file
          profile: default
        accessMode: ReadWrite
        credential:
          name: cloud-credentials
          key: data
{% if infrastructure.resources.0.status.platformStatus.type == 'AWS' %}
  snapshotLocations:
    - name: default
      velero:
        provider: aws
        config:
          region: {{ velero_instance_bucket_region }}
          # Choose a profile from the AWS config file
          profile: default
{% endif %}
{% if infrastructure.resources.0.status.platformStatus.type == 'VSphere' %}
  snapshotLocations:
    - velero:
        provider: velero.io/vsphere
{% endif %}
