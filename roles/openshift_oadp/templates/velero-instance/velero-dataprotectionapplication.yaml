apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionApplication
metadata:
  name: velero
  namespace: {{ velero_instance_namespace }}
spec:
  configuration:
    velero:
      defaultPlugins:
        # The openshift plug-in is mandatory.
        - openshift
        - aws
{% if not velero_instance_vsphere_enabled %}
        - csi
      featureFlags:
        - EnableCSI
{% endif %}
{% if velero_instance_vsphere_enabled %}
      customPlugins:
        # OADP operator doesn't support vsphere on the default Velero plugin list.
        # Need to enable vsphere plugin as a custom Velero plugin.
        - name: vsphere
          image: vsphereveleroplugin/velero-plugin-for-vsphere:v1.3.0-rc2
      featureFlags:
        # If local mode is enabled, Velero vSphere plugin will skip the upload of volume
        # snapshots to S3. The datamgr-for-vsphere-plugin pod won't be deployed at all.
        #- EnableLocalMode
{% endif %}
      # If you need to install Velero without a default backup storage location
      # NoDefaultBackupLocation flag is required for confirmation
      noDefaultBackupLocation: false
    restic:
      enable: false
  backupLocations:
    - velero:
        provider: aws
        # Default indicates this location is the default backup storage location
        default: true
        objectStorage:
          # Name of an existing bucket
          bucket: '{{ velero_s3_storage.bucket_name }}'
          # In the bucket, a prefix subdirectory will be created
          prefix: velero
        config:
{% if velero_s3_storage.s3_url is defined %}
          s3Url: '{{ velero_s3_storage.s3_url }}'
{% endif %}
{% if velero_s3_storage.s3_force_path_style is defined %}
          s3ForcePathStyle: '{{ velero_s3_storage.s3_force_path_style }}'
{% endif %}
{% if velero_s3_storage.insecure_skip_tls_verify is defined %}
          insecureSkipTLSVerify: '{{ velero_s3_storage.insecure_skip_tls_verify }}'
{% endif %}
{% if velero_s3_storage.ca_cert is defined and velero_s3_storage.ca_cert | length > 0 %}
          caCert: |
            {{ velero_s3_storage.ca_cert | indent(12) }}
{% endif %}
{% if velero_s3_storage.aws_region is defined %}
          region: '{{ velero_s3_storage.aws_region }}'
{% endif %}
          # Choose a profile from the AWS config file
          profile: default
        accessMode: ReadWrite
        credential:
          name: cloud-credentials
          key: data
{% if velero_instance_vsphere_enabled %}
  snapshotLocations:
    - velero:
        provider: velero.io/vsphere
{% endif %}
  features:
    dataMover:
      enable: {{ velero_datamover_enabled }}
      credentialName: dm-credential
