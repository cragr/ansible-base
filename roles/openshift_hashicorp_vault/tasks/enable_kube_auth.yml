- name: Create a static service account token
  kubernetes.core.k8s:
    template: vault-token-static-secret.yaml
    namespace: '{{ hashicorp_vault_namespace }}'
    wait: true

- name: Grab vault's service account token secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: '{{ hashicorp_vault_name }}-token-static'
    namespace: '{{ hashicorp_vault_namespace }}'
  register: vault_serviceaccount_secret

- name: Grab vault's service account CA
  command: >-
    oc exec --namespace {{ hashicorp_vault_namespace }} {{ hashicorp_vault_name }}-0 -- cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  changed_when: false
  register: kubernetes_ca_cert

- name: Grab OpenShift API server URL
  command: oc whoami --show-server
  changed_when: false
  register: kubernetes_host

- name: Enable Kubernetes authentication
  hashivault_auth_method:
    method_type: kubernetes
    state: enabled
  environment:
    VAULT_ADDR: '{{ hashicorp_vault_addr }}'
    VAULT_SKIP_VERIFY: '{{ hashicorp_vault_skip_verify }}'
    VAULT_TOKEN: '{{ hashicorp_vault_token }}'

- name: Configure Kubernetes authentication
  hashivault_write:
    secret: /auth/kubernetes/config
    data:
      issuer: https://kubernetes.default.svc
      token_reviewer_jwt: '{{ vault_serviceaccount_secret.resources.0.data.token | b64decode | default("") }}'
      kubernetes_ca_cert: '{{ kubernetes_ca_cert.stdout }}'
      kubernetes_host: '{{ kubernetes_host.stdout }}'
  environment:
    VAULT_ADDR: '{{ hashicorp_vault_addr }}'
    VAULT_SKIP_VERIFY: '{{ hashicorp_vault_skip_verify }}'
    VAULT_TOKEN: '{{ hashicorp_vault_token }}'

- name: Grant read access to all secrets to Kubernetes identities
  hashivault_policy:
    name: kube_read
    rules: |
      path "kv/data/*"
      {
        capabilities = [ "read", "list" ]
      }
  environment:
    VAULT_ADDR: '{{ hashicorp_vault_addr }}'
    VAULT_SKIP_VERIFY: '{{ hashicorp_vault_skip_verify }}'
    VAULT_TOKEN: '{{ hashicorp_vault_token }}'

- name: Define kube role
  hashivault_write:
    secret: /auth/kubernetes/role/kube
    data:
      bound_service_account_names: default
      bound_service_account_namespaces: '*'
      policies: kube_read
  environment:
    VAULT_ADDR: '{{ hashicorp_vault_addr }}'
    VAULT_SKIP_VERIFY: '{{ hashicorp_vault_skip_verify }}'
    VAULT_TOKEN: '{{ hashicorp_vault_token }}'

- name: Define external_secrets role
  hashivault_write:
    secret: /auth/kubernetes/role/external-secrets
    data:
      bound_service_account_names: external-secrets,default
      bound_service_account_namespaces: external-secrets,default
      policies: kube_read
  environment:
    VAULT_ADDR: '{{ hashicorp_vault_addr }}'
    VAULT_SKIP_VERIFY: '{{ hashicorp_vault_skip_verify }}'
    VAULT_TOKEN: '{{ hashicorp_vault_token }}'
