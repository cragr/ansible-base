- name: Deploy standalone Splunk instance
  kubernetes.core.k8s:
    template:
      - instance/splunk-ns.yaml
      - instance/standalone-sa.yaml
      - instance/standalone-scc-rolebinding.yaml
      - instance/splunk-splunk-secret.yaml
      - instance/standalone-standalone.yaml
      - instance/standalone-hec-route.yaml
      - instance/standalone-web-route.yaml

- name: Waiting since {{ lookup("pipe", "date +%r") }} for {{ splunk_instance_namespace }}/{{ splunk_instance_namespace }}-{{ splunk_instance_name }}-standalone statefulset to deploy
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    name: '{{ splunk_instance_namespace }}-{{ splunk_instance_name }}-standalone'
    namespace: '{{ splunk_instance_namespace }}'
  register: splunk_sts_result
  until:
    - splunk_sts_result.resources.0.status.availableReplicas is defined
    - splunk_sts_result.resources.0.status.availableReplicas > 0
  retries: 60
  delay: 10

- import_tasks: get_hec_connection.yml

- name: Waiting since {{ lookup("pipe", "date +%r") }} for Splunk to come up
  uri:
    url: '{{ splunk_hec_json_endpoint }}'
    method: POST
    headers:
      Authorization: Splunk {{ splunk_hec_token }}
    body_format: json
    body:
      event: Hello from Ansible at {{ lookup("pipe", "date +%r") }}
    validate_certs: false
  register: result
  until: result.status == 200
  retries: 12
  delay: 10
