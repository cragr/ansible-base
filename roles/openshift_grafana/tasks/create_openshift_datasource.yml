# See also:
# Custom Grafana dashboards for Red Hat OpenShift Container Platform 4
# https://www.redhat.com/en/blog/custom-grafana-dashboards-red-hat-openshift-container-platform-4

- name: Create a static service account token
  kubernetes.core.k8s:
    template: metrics/grafana-serviceaccount-token-static-secret.yaml
    namespace: '{{ grafana_instance_namespace }}'
    wait: true

- name: Grab grafana service account token secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: '{{ grafana_instance_name }}-serviceaccount-token-static'
    namespace: '{{ grafana_instance_namespace }}'
  register: grafana_serviceaccount_secret

- name: Set grafana_serviceaccount_token
  set_fact:
    grafana_serviceaccount_token: >-
      {{ grafana_serviceaccount_secret.resources.0.data.token | b64decode | default('') }}

- fail:
    msg: Failed to retrieve token for the grafana service account.
  when: grafana_serviceaccount_token | length == 0

- name: Allow Grafana to retrieve OpenShift monitoring metrics
  kubernetes.core.k8s:
    template:
      - metrics/grafana-cluster-monitoring-view-clusterrolebinding.yaml
      - metrics/openshift-monitoring-grafanadatasource.yaml
    namespace: '{{ grafana_instance_namespace }}'
