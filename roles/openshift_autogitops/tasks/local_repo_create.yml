- import_role:
    name: openshift_gitea
    tasks_from: get_connection.yml
  vars:
    gitea_repo_name: '{{ autogitops_git_repo_name }}'

- name: Retrieve cluster URL
  command: oc whoami --show-server
  changed_when: false
  register: oc_whoami_result

- set_fact:
    autogitops_cluster_name: '{{ oc_whoami_result.stdout | regex_replace("https://api\.(.*):6443", "\1") }}'

- set_fact:
    autogitops_git_dir: '{{ autogitops_workspace_dir }}/{{ autogitops_cluster_name }}'

- name: Cluster local git directory
  debug:
    var: autogitops_git_dir

- name: Ensure local git directory exists
  file:
    path: '{{ autogitops_git_dir }}'
    state: directory
    mode: '0700'

- name: Pull GitOps state from cluster
  git:
    repo: '{{ gitea_repo_url_creds }}'
    dest: '{{ autogitops_git_dir }}'
    force: true
