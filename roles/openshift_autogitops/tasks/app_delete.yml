- import_tasks: local_repo_create.yml

- set_fact:
    autogitops_app_helm_dir: '{{ autogitops_git_dir}}/apps/{{ autogitops_app_path }}'
    autogitops_app_env_dir:  '{{ autogitops_git_dir}}/envs/in-cluster/infra/{{ autogitops_app_name }}'

- name: Delete application helm template directory {{ autogitops_app_helm_dir }}/templates
  file:
    path: '{{ autogitops_app_helm_dir }}/templates'
    state: absent

- name: Check if Chart.yaml exists
  stat:
    path: '{{ autogitops_app_helm_dir }}/Chart.yaml'
  register: autogitops_app_chart_stat_result

- name: Retrieve application Chart.yaml
  slurp:
    path: '{{ autogitops_app_helm_dir }}/Chart.yaml'
  register: autogitops_app_chart_result
  when: autogitops_app_chart_stat_result.stat.exists

- name: Remove dependencies from Chart.yaml
  copy:
    content: >-
      {{ autogitops_app_chart_result.content | b64decode | from_yaml | combine({"dependencies":[]}) | to_nice_yaml }}
    dest: '{{ autogitops_app_helm_dir }}/Chart.yaml'
  when: autogitops_app_chart_stat_result.stat.exists

- import_tasks: local_repo_push.yml

- name: Check if application {{ autogitops_app_name }} exists
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    name: 'in-cluster-{{ autogitops_app_name }}'
    namespace: '{{ autogitops_argocd_namespace }}'
  register: autogitops_app_resource_result

- import_tasks: app_sync_delete.yml
  when: autogitops_app_resource_result.resources | length == 1

- name: Delete application directories
  file:
    path: '{{ item }}'
    state: absent
  loop:
    - '{{ autogitops_app_helm_dir }}'
    - '{{ autogitops_app_env_dir }}'

- import_tasks: local_repo_push.yml

- name: Wait for application {{ autogitops_app_name }} to disappear
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    name: 'in-cluster-{{ autogitops_app_name }}'
    namespace: '{{ autogitops_argocd_namespace }}'
  register: autogitops_app_resource_result
  when: autogitops_git_updated
  until:
    - autogitops_app_resource_result.resources | length == 0
  retries: 60
  delay: 1
