- import_role:
    name: openshift_gitops
    tasks_from: get_argocd_api_connection.yml

- name: Trigger application sync
  uri:
    url: https://{{ argocd_route.resources.0.spec.host }}/api/v1/applications/in-cluster-infra-{{ autogitops_app_name }}/sync
    method: POST
    body_format: json
    body:
      prune: true
      revision: '{{ autogitops_git_last_commit }}'
    headers:
      Authorization: Bearer {{ argocd_api_token }}
    validate_certs: false
    status_code: [ 200 ]
  register: autogitops_app_sync_result
  until:
    - autogitops_app_sync_result.json.status.reconciledAt is defined
  retries: 120
  delay: 5
