- import_role:
    name: openshift_gitops
    tasks_from: get_argocd_api_connection.yml

- name: Trigger application sync
  uri:
    url: https://{{ argocd_route.resources.0.spec.host }}/api/v1/applications/in-cluster-infra-{{ autogitops_app_name }}/sync
    method: POST
    body_format: json
    body:
      prune: true
      revision: '{{ autogitops_git_last_commit }}'
    headers:
      Authorization: Bearer {{ argocd_api_token }}
    validate_certs: false
    status_code: [ 200, 400 ]
  register: argocd_app_sync_result
  until:
    argocd_app_sync_result.status == 200
  retries: 120
  delay: 5

- name: Waiting since {{ lookup("pipe", "date +%r") }} for {{ autogitops_app_name }} to reconcile
  uri:
    url: https://{{ argocd_route.resources.0.spec.host }}/api/v1/applications/in-cluster-infra-{{ autogitops_app_name }}
    method: GET
    headers:
      Authorization: Bearer {{ argocd_api_token }}
    validate_certs: false
    status_code: [ 200 ]
  failed_when: argocd_app_get_result.status != 200
  register: argocd_app_get_result
  until:
    - argocd_app_get_result.json.status.reconciledAt != argocd_app_sync_result.json.status.reconciledAt
    - argocd_app_get_result.json.status.sync.status == 'Synced'
    - argocd_app_get_result.json.status.health.status == 'Healthy'
  retries: 120
  delay: 5

- set_fact:
    argocd_app_reconciled: >-
      {{ argocd_app_get_result.json.status.reconciledAt != argocd_app_sync_result.json.status.reconciledAt }}
    argocd_app_synced: >-
      {{ argocd_app_get_result.json.status.sync.status == 'Synced' }}
    argocd_app_healthy: >-
      {{ argocd_app_get_result.json.status.health.status == 'Healthy' }}

- debug:
    msg: "Application {{ autogitops_app_name }} updated successfully"
  when: argocd_app_reconciled and argocd_app_synced and argocd_app_healthy

- debug:
    msg: "Application {{ autogitops_app_name }} reconciliation failed"
  when: not argocd_app_reconciled

- name: Resources failed to sync
  debug:
    var: argocd_app_get_result.json.status | json_query("resources[?status!='Synced']")
  when: not argocd_app_synced

- name: Unhealthy resources
  debug:
    var: argocd_app_get_result.json.status | json_query("resources[?health.status!=nil && health.status!='Healthy']")
  when: not argocd_app_healthy

- fail:
    msg: Application update failed
  when: not (argocd_app_reconciled and argocd_app_synced and argocd_app_healthy)
