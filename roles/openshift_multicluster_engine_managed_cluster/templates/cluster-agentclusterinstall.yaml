{% if multicluster_engine_managed_cluster_platform == 'BareMetal' %}
apiVersion: extensions.hive.openshift.io/v1beta1
kind: AgentClusterInstall
metadata:
  annotations:
    agent-install.openshift.io/install-config-overrides: '{{ lookup("template", "assisted-installer/install-config.yaml") | from_yaml | to_json }}'
  name: {{ multicluster_engine_managed_cluster.cluster_name }}
  namespace: {{ multicluster_engine_managed_cluster.cluster_name }}
spec:
  apiVIP: {{ multicluster_engine_managed_cluster.api_vip }}
  ingressVIP: {{ multicluster_engine_managed_cluster.ingress_vip }}
  clusterDeploymentRef:
    name: {{ multicluster_engine_managed_cluster.cluster_name }}
  holdInstallation: false
  provisionRequirements:
    controlPlaneAgents: {{ multicluster_engine_managed_cluster.cluster_nodes.values() | selectattr('role', 'equalto', 'master') | length }}
    workerAgents: {{ multicluster_engine_managed_cluster.cluster_nodes.values() | selectattr('role', 'equalto', 'worker') | length }}
  # By default, SMT (or hyperthreading) is enabled to increase the performance of your machines' cores.
  # Therefore, you can omit this section unless you wish to disable hyperthreading.
  # You can disable SMT by setting the parameter value to 'Disabled'. Then, you must disable it in all cluster machines;
  # this includes both control plane and compute machines.
  controlPlane:
    hyperthreading: Enabled
    name: master
  compute:
  - hyperthreading: Enabled
    name: worker
  imageSetRef:
    name: img{{ multicluster_engine_managed_cluster.ocp_release_image | regex_replace('_', '-',) }}-appsub
  networking:
    clusterNetwork:
    - cidr: 10.128.0.0/14
      hostPrefix: 23
    serviceNetwork:
    - 172.30.0.0/16
    userManagedNetworking: false
{% if multicluster_engine_managed_cluster.clusterwide_proxy %}
  proxy:
    httpProxy: {{ multicluster_engine_managed_cluster.clusterwide_proxy.http_proxy }}
    httpsProxy: {{ multicluster_engine_managed_cluster.clusterwide_proxy.https_proxy }}
    noProxy: {{ multicluster_engine_managed_cluster.clusterwide_proxy.no_proxy }}
{% endif %}
  sshPublicKey: '{{ multicluster_engine_managed_cluster.ssh_authorized_key }}'
{% endif %}
